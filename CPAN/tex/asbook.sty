\usepackage{polyglossia}
\usepackage{fontspec}
\usepackage{multicol}
\usepackage{xltxtra}
\usepackage{url}
\usepackage{framed}
\usepackage{fancyvrb}
\fvset{numbers=left}


\usepackage{titleref}

\defaultfontfeatures{Scale=MatchLowercase}
\setmainfont[Mapping=tex-text]{Baskerville}
\setsansfont[Mapping=tex-text]{Skia}
\setmonofont{Courier}

\usepackage{color}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% 1. Set Chapter style

\def\@makechapterhead#1{%
  \vspace*{10\p@}%
  {\parindent \z@ \raggedright \normalfont
    \ifnum \c@secnumdepth >\m@ne
      \if@mainmatter
      {\huge\bfseries\fontspec[Variant=2,Color=DDDDDDFF,Scale=2]{Zapfino}\@chapapp\space \thechapter}\\[-30\p@]
      
      \fi
    \fi
    \interlinepenalty\@M
    {
      \fontspec[Contextuals={WordInitial,WordFinal},Color=00000055,Scale=2.5]{Hoefler Text Italic}  #1\par\nobreak
    }
    \vskip 15\p@
  }}

\def\@makeschapterhead#1{%
  \vspace*{50\p@}%
  {\parindent \z@ \raggedright
    \normalfont
    \interlinepenalty\@M
    {
      \fontspec[Contextuals={WordInitial,WordFinal},Color=00000055,Scale=2.5]{Hoefler Text Italic}  #1\par\nobreak
    }
    \vskip 15\p@
  }}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% 2. Set Section style

\def\section{\@ifstar\unnumberedsection\numberedsection}

\def\numberedsection{\@ifnextchar[%]
  \numberedsectionwithtwoarguments\numberedsectionwithoneargument}

\def\unnumberedsection{\@ifnextchar[%]
  \unnumberedsectionwithtwoarguments\unnumberedsectionwithoneargument}

\def\numberedsectionwithoneargument#1{\numberedsectionwithtwoarguments[#1]{#1}}

\def\unnumberedsectionwithoneargument#1{\unnumberedsectionwithtwoarguments[#1]{#1}}

\def\numberedsectionwithtwoarguments[#1]#2{%
  \ifhmode\par\fi
  \removelastskip
  \vskip 3ex\goodbreak
  \refstepcounter{section}%
  \noindent
  \begingroup
  \leavevmode\Large\raggedright
  \llap{\fontspec[Variant=2,Color=BBBBBBFF,Scale=1]{Zapfino}\thesection}%
  {\ \ \fontspec[Contextuals={WordInitial,WordFinal},Color=00000055,Scale=1.25]{Hoefler Text Italic} #2}
  \par
  \endgroup
  \vskip 2ex\nobreak
  \addcontentsline{toc}{section}{%
    \protect\numberline{\thesection}%
    #1}%
  }

\def\unnumberedsectionwithtwoarguments[#1]#2{%
  \ifhmode\par\fi
  \removelastskip
  \vskip 3ex\goodbreak
%  \refstepcounter{section}%
  \noindent
  \begingroup
  \leavevmode\Large\bfseries\raggedright
  \leavevmode\Large\bfseries\raggedright
%  \thesection\quad 
  {\fontspec[Contextuals={WordInitial,WordFinal},Color=00000055,Scale=1.25]{Hoefler Text Italic} #2}
  \par
  \endgroup
  \vskip 2ex\nobreak
  \addcontentsline{toc}{section}{%
%    \protect\numberline{\thesection}%
    #1}%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% 3. Title page

\newcommand{\subtitle}[1]{\def\@subtitle{#1}}
\renewcommand{\and}{\\[2mm]}

\renewcommand{\maketitle}{
  \thispagestyle{empty}
  \mbox{}
  \vfill
  \begin{center}
    \noindent{\huge\bfseries \fontspec[Color=33333355,Scale=2]{Hoefler Text Italic}\@title}\\    

    \vskip 1cm

    {\fontspec[Contextuals={WordInitial,WordFinal},Color=999999FF,Scale=1.5]{Hoefler Text Italic} \@subtitle}
  \vfill
    {\fontspec[Contextuals={WordInitial,WordFinal},Color=33333355,Scale=1.5]{Hoefler Text Italic} \@date}
  \end{center}
  \vfill
  \begin{leftbar}
    \fontspec[Contextuals={WordInitial,WordFinal},Color=33333355,Scale=1.5]{Hoefler Text Italic}
    \noindent    \@author
  \end{leftbar}
  \cleardoublepage
}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% 4. Headings and Footers

\pagestyle{plain}
\usepackage{fancyhdr}
\fancyhead[LE,RO]{\small\thepage}
\fancyfoot[R,L]{}
%%\fancyfoot[C]{\today}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0pt}
\fancyfoot[C]{}
\renewcommand{\chaptermark}[1]{\markboth{ \thechapter.\ #1}{}}
\renewcommand{\sectionmark}[1]{\markright{ \thesection.\ #1}}
%\rhead{\nouppercase{\rightmark}}
%\lhead{\nouppercase{\leftmark}}
\fancyhead[LO]{\nouppercase{\small\rightmark}}
\fancyhead[RE]{\nouppercase{\small\leftmark}}
%\fancyhead[RE,LO]{}      






\newenvironment{cpaninfo}{\begin{flushright}\parskip 0pt}{\end{flushright}}




\usepackage{listings}

\lstset{ %
  language=Perl,                % choose the language of the code
  basicstyle=\small,            % the size of the fonts that are used for the code
  numbers=left,                 % where to put the line-numbers
  numberstyle=\tiny,            % the size of the fonts that are used for the line-numbers
  % stepnumber=2,                   % the step between two line-numbers.
  % numbersep=5pt,                  % how far the line-numbers are from the code
  % backgroundcolor=\color{white},  % choose the background color. You must add \usepackage{color}
  showspaces=false,             % show spaces adding particular underscores
  showstringspaces=false,       % underline spaces within strings
  showtabs=false,               % show tabs within strings adding particular underscores
  frame=single,                 % adds a frame around the code
  frameround=ttff,              % what round corners. Start in top right, clockwise
  % tabsize=2,	                % sets default tabsize to 2 spaces
  % captionpos=b,                   % sets the caption-position to bottom
  % breaklines=true,                % sets automatic line breaking
  % breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
  % title=\lstname,                 % show the filename of files included with \lstinputlisting;
  % escapeinside={\%*}{*)},         % if you want to add a comment within your code
  morekeywords={given,when}     % if you want to add more keywords to the set
  identifierstyle=\ttfamily,
  keywordstyle=\bfseries,
  commentstyle=\it,
  stringstyle=\sf,
}
